---

---

<style>
	div.board {
		float: left;
		max-width: 500px;
		width: calc(100vw - 40px);
		margin-right: 20px;
		margin-bottom: 20px;
	}
	div.board.board-small {
		max-width: 320px;
	}
	div.board.board-large {
		max-width: 680px;
	}
</style>

<div class="board" id="board"></div>
<script>
	import {
		INPUT_EVENT_TYPE,
		Chessboard,
	} from "cm-chessboard/src/Chessboard.js";
	import { RightClickAnnotator } from "cm-chessboard/src/extensions/right-click-annotator/RightClickAnnotator.js";
	import { PromotionDialog } from "cm-chessboard/src/extensions/promotion-dialog/PromotionDialog.js";
	import { ARROW_TYPE } from "cm-chessboard/src/extensions/arrows/Arrows.js";

	import "cm-chessboard/assets/chessboard.css";
	import "cm-chessboard/assets/extensions/markers/markers.css";
	import "cm-chessboard/assets/extensions/arrows/arrows.css";

	import { Chess } from "chess.js";

	const game = new Chess();

	const engine = new Worker("/stockfish/stockfish.js");
	engine.onmessage = (event) => {
		const message = event.data;
		if (typeof message === "string" && message.includes("Final evaluation")) {
			const match = message.match(/Final evaluation\s+([+-]?\d+\.?\d*)/);
			if (match) {
				const score = match[1];
				console.log(`Eval: ${score}`);
			}
		}
		if (typeof message === "string" && message.startsWith("bestmove")) {
			const bestMove = message.split(" ")[1];
			if (bestMove && bestMove.length >= 4) {
				const from = bestMove.substring(0, 2);
				const to = bestMove.substring(2, 4);
				board.addArrow(ARROW_TYPE.default, from, to);
			}
		}
	};

	function updateEngine() {
		engine.postMessage("ucinewgame");
		engine.postMessage(`position fen ${game.fen()}`);
		engine.postMessage("go depth 30");

		engine.postMessage("eval");
	}

	const board = new Chessboard(document.getElementById("board"), {
		position: game.fen(),
		assetsUrl: "https://cdn.jsdelivr.net/npm/cm-chessboard@8/assets/",
		extensions: [{ class: RightClickAnnotator }, { class: PromotionDialog }],
	});

	board.enableMoveInput((event) => {
		switch (event.type) {
			case INPUT_EVENT_TYPE.moveInputStarted:
				const pieceColor = event.piece.charAt(0);
				return game.turn() === pieceColor;

			case INPUT_EVENT_TYPE.validateMoveInput:
				const isPromotion =
					event.piece.charAt(1) === "p" &&
					((event.squareTo.charAt(1) === "8" && game.turn() === "w") ||
						(event.squareTo.charAt(1) === "1" && game.turn() === "b"));

				if (isPromotion) {
					board.showPromotionDialog(event.squareTo, game.turn(), (result) => {
						if (result && result.piece) {
							const move = game.move({
								from: event.squareFrom,
								to: event.squareTo,
								promotion: result.piece.charAt(1),
							});
							if (move) {
								board.setPosition(game.fen(), true);
								updateEngine();
							}
						} else {
							board.setPosition(game.fen(), true);
						}
					});
					return true;
				}

				try {
					const move = game.move({
						from: event.squareFrom,
						to: event.squareTo,
					});

					if (move) {
						game.undo();
						return true;
					}
				} catch (e) {
					return false;
				}
				return false;

			case INPUT_EVENT_TYPE.moveInputFinished:
				if (event.legalMove) {
					board.removeMarkers();
					board.removeArrows();
					game.move({
						from: event.squareFrom,
						to: event.squareTo,
					});

					board.setPosition(game.fen(), true);
					updateEngine();
				}
				break;
		}
	});

	updateEngine();
</script>
